{% extends "base.html" %}

{% block title %}‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ - Smart Scan Face{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h1>
    <p>‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
</div>

<div class="card">
    <!-- Scan Mode Tabs -->
    <div class="scan-tabs">
        <button class="scan-tab active" onclick="switchRegisterMode('camera')">
            üì∑ ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á
        </button>
        <button class="scan-tab" onclick="switchRegisterMode('upload')">
            ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
        </button>
    </div>

    <!-- Camera Mode -->
    <div id="cameraMode" class="scan-content active">
        <div class="camera-container">
            <video id="videoElement" autoplay playsinline></video>
            <canvas id="canvasElement" style="display: none;"></canvas>
            <div class="camera-overlay"></div>
        </div>
        <div class="action-buttons">
            <button id="captureBtn" class="btn btn-primary btn-lg" onclick="registerFromCamera()">
                üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
            </button>
        </div>
    </div>

    <!-- Upload Mode -->
    <div id="uploadMode" class="scan-content">
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div id="uploadPlaceholder">
                <div class="upload-icon">üì∑</div>
                <h3>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
                <p>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå JPG, PNG</p>
                <p class="text-muted" style="margin-top: 8px; font-size: 0.85rem;">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ñ‡∏ß‡∏£‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</p>
            </div>
            <div id="previewWrapper" class="preview-wrapper hidden">
                <img id="previewImage" src="" alt="Preview">
                <div class="preview-actions">
                    <button type="button" class="btn btn-primary" onclick="registerFromUpload(event)">
                        ‚úì ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearUploadPreview(event)">
                        ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ
                    </button>
                </div>
            </div>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
        </div>
    </div>
</div>

<!-- Instructions Card -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2>
    </div>
    <ul class="instructions-list">
        <li>‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</li>
        <li>‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πâ‡∏≠‡∏á</li>
        <li>‡πÑ‡∏°‡πà‡∏™‡∏ß‡∏°‡πÅ‡∏ß‡πà‡∏ô‡∏Å‡∏±‡∏ô‡πÅ‡∏î‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏ß‡∏Å</li>
        <li>‡πÉ‡∏´‡πâ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏†‡∏≤‡∏û (1 ‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</li>
    </ul>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/camera.js"></script>
<script>
    let currentMode = 'camera';
    let uploadedImageData = null;

    document.addEventListener('DOMContentLoaded', function() {
        initCamera('videoElement');
    });

    // ‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î
    function switchRegisterMode(mode) {
        currentMode = mode;

        document.querySelectorAll('.scan-tab').forEach(tab => tab.classList.remove('active'));
        event.target.closest('.scan-tab').classList.add('active');

        document.getElementById('cameraMode').classList.remove('active');
        document.getElementById('uploadMode').classList.remove('active');

        if (mode === 'camera') {
            document.getElementById('cameraMode').classList.add('active');
            initCamera('videoElement');
        } else {
            document.getElementById('uploadMode').classList.add('active');
            stopCamera();
        }
    }

    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageData = e.target.result;
                document.getElementById('previewImage').src = uploadedImageData;
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('previewWrapper').classList.remove('hidden');
                document.getElementById('uploadArea').classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }
    }

    // ‡∏•‡πâ‡∏≤‡∏á preview
    function clearUploadPreview(event) {
        event.stopPropagation();
        uploadedImageData = null;
        document.getElementById('fileInput').value = '';
        document.getElementById('previewImage').src = '';
        document.getElementById('uploadPlaceholder').classList.remove('hidden');
        document.getElementById('previewWrapper').classList.add('hidden');
        document.getElementById('uploadArea').classList.remove('has-image');
    }

    // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á
    async function registerFromCamera() {
        const btn = document.getElementById('captureBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

        try {
            const imageData = captureImage('videoElement', 'canvasElement');

            const response = await fetch('/api/register-face', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_base64: imageData })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast('success', result.message + ' (ID: ' + result.student_db_id + ')');
            } else {
                showToast('error', result.detail || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }

        } catch (error) {
            showToast('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
            console.error(error);
        }

        btn.disabled = false;
        btn.innerHTML = 'üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
    }

    // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î
    async function registerFromUpload(event) {
        event.stopPropagation();

        if (!uploadedImageData) {
            showToast('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô');
            return;
        }

        const btns = document.querySelectorAll('#previewWrapper .btn-primary');
        btns.forEach(btn => {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
        });

        try {
            const response = await fetch('/api/register-face', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_base64: uploadedImageData })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast('success', result.message + ' (ID: ' + result.student_db_id + ')');
                clearUploadPreview(event);
            } else {
                showToast('error', result.detail || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }

        } catch (error) {
            showToast('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
            console.error(error);
        }

        btns.forEach(btn => {
            btn.disabled = false;
            btn.innerHTML = '‚úì ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ';
        });
    }
</script>
{% endblock %}
