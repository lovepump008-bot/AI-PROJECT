{% extends "base.html" %}

{% block title %}‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - Smart Scan Face{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
    <p>‡∏î‡∏π Log ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
</div>

<!-- Filter -->
<div class="card">
    <div class="grid grid-3">
        <div class="form-group">
            <label class="form-label">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ä‡∏≤:</label>
            <select id="filterClass" class="form-control" onchange="loadLogs()">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="AI ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå">AI ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå</option>
                <option value="Computer Vision">Computer Vision</option>
                <option value="Machine Learning">Machine Learning</option>
                <option value="Deep Learning">Deep Learning</option>
                <option value="Data Science">Data Science</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
            <input type="date" id="filterDate" class="form-control date-filter-input" onchange="loadLogs()">
        </div>

        <div class="form-group">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-primary" onclick="loadLogs()" style="width: 100%;">
                ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            </button>
        </div>
    </div>
</div>

<!-- Summary -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
    </div>
    <div class="grid grid-3">
        <div class="summary-card">
            <h3 id="todayCount">0</h3>
            <p>‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
        </div>
        <div class="summary-card">
            <h3 id="lastCheckIn" style="font-size: 1.3rem;">-</h3>
            <p>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
        </div>
        <div class="summary-card">
            <h3 id="todayDate" style="font-size: 1.1rem;">-</h3>
            <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</p>
        </div>
    </div>
</div>

<!-- Logs List -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title"> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
    </div>

    <div id="logsContainer">
    </div>

    <div id="emptyState" class="empty-state hidden">
        <div class="empty-state-icon">üìù</div>
        <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('filterDate').value = `${yyyy}-${mm}-${dd}`;
        
        loadLogs();
        document.getElementById('todayDate').textContent =
            new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

        // Auto refresh ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(loadLogs, 30000);
    });

    async function loadLogs() {
        const dateFilter = document.getElementById('filterDate').value;
        const className = document.getElementById('filterClass').value;

        let url = '/api/logs';
        const params = new URLSearchParams();
        
        if (dateFilter) {
            params.append('date', dateFilter);
        }
        if (className) {
            params.append('class_name', className);
        }
        
        if (params.toString()) {
            url += '?' + params.toString();
        }

        try {
            const response = await fetch(url);
            const result = await response.json();

            if (result.success) {
                renderLogs(result.data);
                updateSummary(result.data);
            }
        } catch (error) {
            console.error('Error loading logs:', error);
        }
    }

    function renderLogs(logs) {
        const container = document.getElementById('logsContainer');
        const emptyState = document.getElementById('emptyState');

        if (logs.length === 0) {
            container.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }

        emptyState.classList.add('hidden');

        container.innerHTML = logs.map(log => {
            const checkInTime = new Date(log.check_in_time);
            const timeInStr = checkInTime.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateStr = checkInTime.toLocaleDateString('th-TH');
            
            // ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            let timeOutStr = '-';
            if (log.check_out_time) {
                const checkOutTime = new Date(log.check_out_time);
                timeOutStr = checkOutTime.toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }

            const name = log.first_name && log.last_name
                ? `${log.first_name} ${log.last_name}`
                : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';

            const studentId = log.student_id || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™';
            
            // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ badge
            const statusClass = log.status === 'checked_out' ? 'checked-out' : 'checked-in';
            const statusText = log.status === 'checked_out' ? '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : '‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            
            // ‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
            const faceImage = log.face_image_path 
                ? `<img src="${log.face_image_path}" alt="Face" class="log-face-image">` 
                : `<div class="log-face-placeholder">üë§</div>`;

            return `
                <div class="log-entry-with-image">
                    ${faceImage}
                    <div class="log-details">
                        <div class="log-time">
                            ${dateStr}
                            <span class="log-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="log-name">${name}</div>
                        <div>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${studentId}</div>
                        <div class="log-class">‡∏ß‡∏¥‡∏ä‡∏≤: ${log.class_name}</div>
                        <div style="margin-top: 8px; font-size: 0.9rem;">
                            ‚è∞ ‡πÄ‡∏Ç‡πâ‡∏≤: <strong>${timeInStr}</strong>
                            ${log.check_out_time ? ` | üö™ ‡∏≠‡∏≠‡∏Å: <strong>${timeOutStr}</strong>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateSummary(logs) {
        const today = new Date().toDateString();
        const todayLogs = logs.filter(log =>
            new Date(log.check_in_time).toDateString() === today
        );

        document.getElementById('todayCount').textContent = todayLogs.length;

        if (logs.length > 0) {
            const latestLog = logs[0];
            const name = latestLog.first_name && latestLog.last_name
                ? `${latestLog.first_name} ${latestLog.last_name}`
                : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
            document.getElementById('lastCheckIn').textContent = name;
        } else {
            document.getElementById('lastCheckIn').textContent = '-';
        }
    }
</script>
{% endblock %}
