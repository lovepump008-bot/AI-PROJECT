{% extends "base.html" %}

{% block title %}‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ - Smart Scan Face{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h1>
    <p>‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏•‡∏ö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
</div>

<!-- Student Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    </div>

    <div class="table-container">
        <table id="studentTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
            </tbody>
        </table>
    </div>

    <div id="emptyState" class="empty-state hidden">
        <div class="empty-state-icon">üìã</div>
        <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô</p>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>

        <form id="editForm" onsubmit="saveStudent(event)">
            <input type="hidden" id="editId">

            <div class="form-group">
                <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                <input type="text" id="editStudentId" class="form-control" required
                       placeholder="‡πÄ‡∏ä‡πà‡∏ô 6501234567">
            </div>

            <div class="form-group">
                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠</label>
                <input type="text" id="editFirstName" class="form-control" required
                       placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á">
            </div>

            <div class="form-group">
                <label class="form-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" id="editLastName" class="form-control" required
                       placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>

            <div class="action-buttons">
                <button type="submit" class="btn btn-success">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
            <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
        </div>

        <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
        <p><strong id="deleteStudentName"></strong></p>

        <input type="hidden" id="deleteId">

        <div class="action-buttons mt-20">
            <button class="btn btn-danger" onclick="confirmDelete()">üóëÔ∏è ‡∏•‡∏ö</button>
            <button class="btn btn-secondary" onclick="closeDeleteModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', loadStudents);

    async function loadStudents() {
        try {
            const response = await fetch('/api/students');
            const result = await response.json();

            if (result.success) {
                renderStudentTable(result.data);
            }
        } catch (error) {
            showToast('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
            console.error(error);
        }
    }

    function renderStudentTable(students) {
        const tbody = document.getElementById('studentTableBody');
        const emptyState = document.getElementById('emptyState');

        if (students.length === 0) {
            tbody.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }

        emptyState.classList.add('hidden');

        tbody.innerHTML = students.map(student => {
            const hasData = student.student_id && student.first_name && student.last_name;
            const statusBadge = hasData
                ? '<span class="badge badge-success">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö</span>'
                : '<span class="badge badge-warning">‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';

            const displayName = student.first_name || '-';
            const displayLastName = student.last_name || '-';
            const displayStudentId = student.student_id || '-';
            const createdDate = new Date(student.created_at).toLocaleDateString('th-TH');

            return `
                <tr>
                    <td>${student.id}</td>
                    <td>${displayStudentId}</td>
                    <td>${displayName}</td>
                    <td>${displayLastName}</td>
                    <td>${createdDate}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 8px 14px; font-size: 0.85rem;" onclick="openEditModal(${student.id})">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button class="btn btn-danger" style="padding: 8px 14px; font-size: 0.85rem;" onclick="openDeleteModal(${student.id}, '${displayName} ${displayLastName}')">
                            ‡∏•‡∏ö
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function openEditModal(id) {
        try {
            const response = await fetch(`/api/students/${id}`);
            const result = await response.json();

            if (result.success) {
                const student = result.data;
                document.getElementById('editId').value = student.id;
                document.getElementById('editStudentId').value = student.student_id || '';
                document.getElementById('editFirstName').value = student.first_name || '';
                document.getElementById('editLastName').value = student.last_name || '';

                document.getElementById('editModal').classList.add('show');
            }
        } catch (error) {
            showToast('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
        }
    }

    function closeModal() {
        document.getElementById('editModal').classList.remove('show');
    }

    async function saveStudent(event) {
        event.preventDefault();

        const id = document.getElementById('editId').value;
        const data = {
            student_id: document.getElementById('editStudentId').value,
            first_name: document.getElementById('editFirstName').value,
            last_name: document.getElementById('editLastName').value
        };

        try {
            const response = await fetch(`/api/students/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast('success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                closeModal();
                loadStudents();
            } else {
                showToast('error', result.detail || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        } catch (error) {
            showToast('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
        }
    }

    function openDeleteModal(id, name) {
        document.getElementById('deleteId').value = id;
        document.getElementById('deleteStudentName').textContent = name;
        document.getElementById('deleteModal').classList.add('show');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('show');
    }

    async function confirmDelete() {
        const id = document.getElementById('deleteId').value;

        try {
            const response = await fetch(`/api/students/${id}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showToast('success', '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                closeDeleteModal();
                loadStudents();
            } else {
                showToast('error', result.detail || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        } catch (error) {
            showToast('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
        }
    }
</script>
{% endblock %}
