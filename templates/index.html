{% extends "base.html" %}

{% block title %}‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - Smart Scan Face{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
    <p>‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
</div>

<div class="card">
    <!-- Scan Mode Tabs -->
    <div class="scan-tabs">
        <button class="scan-tab active" onclick="switchScanMode('camera')">
            üì∑ ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á
        </button>
        <button class="scan-tab" onclick="switchScanMode('upload')">
            ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
        </button>
    </div>

    <!-- Camera Mode -->
    <div id="cameraMode" class="scan-content active">
        <div class="camera-container">
            <video id="videoElement" autoplay playsinline></video>
            <canvas id="canvasElement" style="display: none;"></canvas>
            <div class="camera-overlay"></div>
        </div>
    </div>

    <!-- Upload Mode -->
    <div id="uploadMode" class="scan-content">
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div id="uploadPlaceholder">
                <div class="upload-icon">üì∑</div>
                <h3>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
                <p>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå JPG, PNG</p>
            </div>
            <div id="previewWrapper" class="preview-wrapper hidden">
                <img id="previewImage" src="" alt="Preview">
                <div class="preview-actions">
                    <button type="button" class="btn btn-secondary" onclick="clearUploadPreview(event)">
                        ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ
                    </button>
                </div>
            </div>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
        </div>
    </div>

    <!-- Class Selection -->
    <div class="form-group mt-20">
        <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤:</label>
        <select id="classSelect" class="form-control">
            <option value="AI ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå">AI ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå</option>
        </select>
    </div>

    <!-- Scan Buttons (Check-in / Check-out) -->
    <div class="scan-type-buttons">
        <button id="checkinBtn" class="btn btn-checkin btn-lg" onclick="checkAttendance('check_in')">
            ‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </button>
        <button id="checkoutBtn" class="btn btn-checkout btn-lg" onclick="checkAttendance('check_out')">
            üö™ ‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏≠‡∏Å
        </button>
    </div>

    <!-- Result Display -->
    <div id="resultContainer" class="result-container">
        <div class="result-icon" id="resultIcon">‚úì</div>
        <div class="result-success">
            <h2 id="resultTitle">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
            <p class="text-muted" id="resultSubtitle">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
        </div>
        <div id="resultFaceImage" style="text-align: center; margin: 15px 0; display: none;">
            <img id="capturedFace" src="" alt="Captured Face" style="width: 120px; height: 120px; border-radius: 12px; object-fit: cover; border: 3px solid #10b981;">
        </div>
        <div class="result-info">
            <div class="result-info-item">
                <span class="result-info-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</span>
                <span class="result-info-value" id="resultName">-</span>
            </div>
            <div class="result-info-item">
                <span class="result-info-label">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>
                <span class="result-info-value" id="resultStudentId">-</span>
            </div>
            <div class="result-info-item">
                <span class="result-info-label">‡∏ß‡∏¥‡∏ä‡∏≤</span>
                <span class="result-info-value" id="resultClass">-</span>
            </div>
            <div class="result-info-item">
                <span class="result-info-label" id="resultTimeLabel">‡πÄ‡∏ß‡∏•‡∏≤</span>
                <span class="result-info-value" id="resultTime">-</span>
            </div>
            <div class="result-info-item">
                <span class="result-info-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
                <span class="result-info-value" id="resultDate">-</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/camera.js"></script>
<script>
    let currentMode = 'camera';
    let uploadedImageData = null;

    document.addEventListener('DOMContentLoaded', function() {
        initCamera('videoElement');
    });

    // ‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î
    function switchScanMode(mode) {
        currentMode = mode;

        document.querySelectorAll('.scan-tab').forEach(tab => tab.classList.remove('active'));
        event.target.closest('.scan-tab').classList.add('active');

        document.getElementById('cameraMode').classList.remove('active');
        document.getElementById('uploadMode').classList.remove('active');

        if (mode === 'camera') {
            document.getElementById('cameraMode').classList.add('active');
            initCamera('videoElement');
        } else {
            document.getElementById('uploadMode').classList.add('active');
            stopCamera();
        }

        document.getElementById('resultContainer').classList.remove('show');
    }

    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageData = e.target.result;
                document.getElementById('previewImage').src = uploadedImageData;
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('previewWrapper').classList.remove('hidden');
                document.getElementById('uploadArea').classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }
    }

    // ‡∏•‡πâ‡∏≤‡∏á preview
    function clearUploadPreview(event) {
        event.stopPropagation();
        uploadedImageData = null;
        document.getElementById('fileInput').value = '';
        document.getElementById('previewImage').src = '';
        document.getElementById('uploadPlaceholder').classList.remove('hidden');
        document.getElementById('previewWrapper').classList.add('hidden');
        document.getElementById('uploadArea').classList.remove('has-image');
    }

    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å
    async function checkAttendance(scanType) {
        const checkinBtn = document.getElementById('checkinBtn');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const className = document.getElementById('classSelect').value;
        
        const isCheckIn = scanType === 'check_in';
        const activeBtn = isCheckIn ? checkinBtn : checkoutBtn;
        const originalText = isCheckIn ? '‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'üö™ ‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏≠‡∏Å';

        checkinBtn.disabled = true;
        checkoutBtn.disabled = true;
        activeBtn.innerHTML = '<span class="spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';

        document.getElementById('resultContainer').classList.remove('show');

        try {
            let imageData;

            if (currentMode === 'camera') {
                imageData = captureImage('videoElement', 'canvasElement');
            } else {
                if (!uploadedImageData) {
                    showToast('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô');
                    resetButtons();
                    return;
                }
                imageData = uploadedImageData;
            }

            const response = await fetch('/api/check-attendance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image_base64: imageData,
                    class_name: className,
                    scan_type: scanType
                })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
                if (result.scan_type === 'check_out') {
                    document.getElementById('resultIcon').textContent = 'üö™';
                    document.getElementById('resultIcon').style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                    document.getElementById('resultTitle').textContent = '‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                    document.getElementById('resultTimeLabel').textContent = '‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å';
                    document.getElementById('resultTime').textContent = result.data.check_out_time;
                } else {
                    document.getElementById('resultIcon').textContent = '‚úì';
                    document.getElementById('resultIcon').style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    document.getElementById('resultTitle').textContent = '‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                    document.getElementById('resultTimeLabel').textContent = '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤';
                    document.getElementById('resultTime').textContent = result.data.check_in_time;
                }
                
                document.getElementById('resultName').textContent = result.data.student_name;
                document.getElementById('resultStudentId').textContent = result.data.student_id;
                document.getElementById('resultClass').textContent = result.data.class_name;
                document.getElementById('resultDate').textContent = result.data.date;
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô
                if (result.data.face_image) {
                    document.getElementById('capturedFace').src = result.data.face_image;
                    document.getElementById('resultFaceImage').style.display = 'block';
                }
                
                document.getElementById('resultContainer').classList.add('show');
                showToast('success', result.message);
            } else {
                showToast('error', result.detail || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }

        } catch (error) {
            showToast('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
            console.error(error);
        }

        resetButtons();
    }
    
    function resetButtons() {
        document.getElementById('checkinBtn').disabled = false;
        document.getElementById('checkoutBtn').disabled = false;
        document.getElementById('checkinBtn').innerHTML = '‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
        document.getElementById('checkoutBtn').innerHTML = 'üö™ ‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏≠‡∏Å';
    }
</script>
{% endblock %}
